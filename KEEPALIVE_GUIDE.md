# 🔄 Codespace 保活功能使用指南

## 📖 功能说明

保活（Keepalive）功能可以自动监控和维护你的 Codespace，确保它在指定时间内保持运行状态。

### 主要特点

- ⏰ **自定义时长**：设置 0.5-24 小时的保活时间
- 🔄 **自动重启**：如果 Codespace 意外停止，自动重新启动
- 📊 **实时监控**：显示剩余保活时间
- 🔔 **状态提示**：直观显示哪些 Codespace 正在保活

---

## 🚀 如何使用

### 1. 启动 Codespace 并设置保活

1. 在 Codespace 列表中找到已停止的 Codespace
2. 点击 **▶️** 按钮
3. 弹出保活设置对话框
4. 设置保活时长（默认 4 小时）
5. 点击 **✅ Start** 启动

![保活设置示例](./docs/keepalive-dialog.png)

### 2. 查看保活状态

正在保活的 Codespace 会显示：
- 🔄 图标
- 剩余时间提示，如：`🔄 (3.5h left)`

### 3. 停止保活

有两种方式停止保活：

#### 方式一：停止 Codespace
点击 **⏸️** 按钮停止 Codespace，同时会取消保活任务。

#### 方式二：仅停止保活
点击保活任务旁的 **❌** 按钮，只停止保活但不停止 Codespace。

---

## 🔧 工作原理

### 保活机制

1. **启动时**：
   - 启动 Codespace
   - 记录启动时间和保活时长
   - 创建保活任务

2. **运行中**（每 10 分钟检查）：
   - 检查是否超过保活时长
   - 检查 Codespace 状态
   - 如果停止且未超时，自动重启

3. **结束时**：
   - 超过保活时长：自动取消任务
   - 手动停止：立即取消任务

### 状态检查

```
每 10 分钟 →  检查 Codespace 状态
                ↓
          是否仍在保活期内？
            ↓           ↓
           是          否
            ↓           ↓
      状态是否正常？   结束任务
        ↓     ↓
      正常   已停止
        ↓     ↓
      继续   重启
```

---

## 💡 使用场景

### 场景 1: 长时间编码会话
**需求**：需要在 4 小时内完成一个功能，但可能会暂时离开。

**方案**：
1. 启动 Codespace，设置 4 小时保活
2. 即使意外断开连接，Codespace 也会保持运行
3. 4 小时后自动停止，避免浪费资源

### 场景 2: 后台任务执行
**需求**：运行一个需要 2 小时的构建或测试任务。

**方案**：
1. 启动任务并设置 2.5 小时保活
2. 可以关闭浏览器，任务继续运行
3. 如果 Codespace 意外停止，自动重启

### 场景 3: 演示准备
**需求**：准备演示，需要 Codespace 在接下来 6 小时内随时可用。

**方案**：
1. 提前启动并设置 6 小时保活
2. 演示期间 Codespace 始终保持就绪
3. 演示结束后自动停止

---

## 📊 界面说明

### 新的表格布局

```
┌─────────┬───────────────────┬─────────┬──────────┬───────────┬────────────────┐
│ Status  │ Codespace / Repo  │ Machine │ Location │ Last Used │ Actions        │
├─────────┼───────────────────┼─────────┼──────────┼───────────┼────────────────┤
│ ✅      │ my-codespace 🔄   │ 2 core  │ WestUs2  │ 5 min ago │ 🔄 ⏸️ ❌      │
│         │ 📦 user/repo      │ 4GB RAM │          │           │                │
│         │ 🌿 main           │         │          │           │                │
│         │ 🌐 Open           │         │          │           │                │
└─────────┴───────────────────┴─────────┴──────────┴───────────┴────────────────┘
```

### 按钮说明

| 按钮 | 说明 | 适用状态 |
|------|------|---------|
| 🔄 | 刷新单个 Codespace | 所有状态 |
| ▶️ | 启动并设置保活 | Stopped/Shutdown |
| ⏸️ | 停止（取消保活） | Available |
| ❌ | 仅停止保活任务 | 保活激活时 |

---

## ⚙️ 配置建议

### 保活时长设置

| 用途 | 推荐时长 | 说明 |
|------|---------|------|
| 短暂离开 | 0.5-1 小时 | 吃饭、开会 |
| 正常编码 | 2-4 小时 | 一个工作会话 |
| 长任务 | 4-8 小时 | 构建、测试 |
| 全天工作 | 8-12 小时 | 工作日 |
| 最长时间 | 24 小时 | 特殊情况 |

### 资源考虑

⚠️ **注意**：
- 保活会持续消耗 Codespace 资源配额
- 建议根据实际需要设置合理的时长
- 不需要时及时停止保活

---

## 🔍 故障排查

### Q: 保活任务没有自动重启 Codespace？

**可能原因**：
1. 保活时长已到期
2. 检查间隔为 10 分钟，可能需要等待
3. GitHub API 限流

**解决方法**：
- 等待下次自动检查（最多 10 分钟）
- 检查保活剩余时间
- 手动点击刷新按钮立即检查

### Q: 页面会自动刷新吗？

**是的**：有活动的保活任务时，页面每 10 分钟自动刷新。

**为什么**：
- 用于检查和维护保活状态
- 如果 Codespace 停止，自动重启

**如何停止**：
- 终止所有保活任务
- 或等待保活时间到期

### Q: 保活时间不准确？

**原因**：时间计算基于本地时间和服务器时间。

**解决方法**：
- 确保系统时间准确
- 刷新页面更新时间显示

### Q: 可以同时保活多个 Codespace 吗？

**可以**！每个 Codespace 独立管理保活任务。

---

## 💾 数据持久化

### 保活任务存储

- **存储位置**：`keepalive_tasks.json` 文件
- **持久化**：✅ 重启后自动恢复
- **适用环境**：本地和 Streamlit Cloud 都支持
- **影响**：应用重启、浏览器关闭后仍然保留

### 存储机制

```
保活任务创建
    ↓
保存到内存 (Session State)
    ↓
同步保存到文件 (keepalive_tasks.json)
    ↓
应用重启
    ↓
自动从文件加载任务
    ↓
恢复保活监控
```

### 自动恢复

**应用启动时**：
1. 读取 `keepalive_tasks.json` 文件
2. 计算每个任务的经过时间
3. 过滤掉已过期的任务
4. 恢复未过期的任务
5. 继续监控和保活

**示例**：
- 设置 4 小时保活
- 应用重启（经过 1 小时）
- 自动恢复，剩余 3 小时
- 继续保活监控

### 数据文件

**文件名**：`keepalive_tasks.json`

**位置**：
- 本地：项目根目录
- Cloud：应用工作目录

**格式**：
```json
{
  "account1_codespace-name": {
    "account_name": "account1",
    "cs_name": "codespace-name",
    "start_time": "2025-10-26T20:30:00",
    "keepalive_hours": 4.0
  }
}
```

**注意**：
- ✅ 文件已在 `.gitignore` 中排除
- ✅ 不会提交到版本控制
- ✅ 本地和云端都会自动创建

---

## 🎯 最佳实践

### ✅ 推荐做法

1. **合理设置时长**：根据实际需要设置，避免浪费
2. **及时取消**：任务完成后立即停止保活
3. **监控状态**：定期查看保活剩余时间
4. **保持标签打开**：确保自动刷新正常工作

### ❌ 避免做法

1. **过长保活**：不要设置超过实际需要的时长
2. **忘记停止**：任务完成后忘记取消保活
3. **同时多任务**：不要同时保活大量 Codespace
4. **关闭浏览器**：这会导致保活任务丢失

---

## 📞 技术支持

遇到问题？
- 查看主文档：[README.md](README.md)
- 安全说明：[SECURITY.md](SECURITY.md)
- 提交 Issue 获取帮助

---

**享受保活功能带来的便利！** 🎉

